<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cracken - Validation LockR</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0B1317;
      color: #ecf0f1;
      font-family: "Segoe UI", Arial, sans-serif;
      padding: 24px;
    }
    .card {
      background: #152028;
      padding: 32px;
      border-radius: 14px;
      max-width: 540px;
      text-align: center;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
    }
    h1 {
      margin-bottom: 1rem;
      color: #44C283;
      font-size: 1.7rem;
    }
    p {
      line-height: 1.55;
      margin: 0 0 1rem;
    }
    .status {
      margin-top: 1.5rem;
      font-weight: bold;
    }
    a {
      color: #44C283;
      word-break: break-all;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Telechargement en preparation</h1>
    <p>Merci d'avoir valide LockR. Gardez cette page ouverte, le launcher va prendre le relais automatiquement.</p>
    <p id="fallback" class="hidden"></p>
    <p class="status" id="status">Connexion au launcher en cours...</p>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const port = params.get('port') || '51732';
    const localCallback = params.get('local_callback') ? decodeURIComponent(params.get('local_callback')) : '';
    const statusEl = document.getElementById('status');
    const fallbackEl = document.getElementById('fallback');

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function showFallback(url) {
      if (!url) return;
      fallbackEl.classList.remove('hidden');
      fallbackEl.innerHTML = 'Lien de secours : <a href="' + url.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener">' + url + '</a>';
    }

    if (!token) {
      setStatus('Token manquant. Relancez le telechargement depuis le launcher.');
      showFallback(localCallback);
    } else {
      showFallback(localCallback);
      const endpoint = `http://127.0.0.1:${port}/api/poll-download?token=${encodeURIComponent(token)}`;

      async function poll() {
        try {
          const response = await fetch(endpoint, { cache: 'no-store' });
          if (!response.ok) {
            throw new Error('HTTP ' + response.status);
          }
          const data = await response.json();

          if (data.message) {
            setStatus(data.message);
          } else if (data.status === 'starting') {
            setStatus('Lancement du telechargement...');
          } else if (data.status === 'pending') {
            setStatus('Connexion au launcher...');
          }

          if (data.status === 'started') {
            setStatus(data.message || 'Telechargement lance dans le launcher. Vous pouvez fermer cette page.');
          } else if (data.status === 'error') {
            setStatus(data.message || 'Une erreur est survenue. Relancez le telechargement depuis le launcher.');
          } else if (data.status === 'unknown') {
            setStatus('Session expiree. Relancez le telechargement depuis le launcher.');
          } else {
            setTimeout(poll, 1500);
          }
        } catch (error) {
          console.error(error);
          setStatus('Tentative de reconnexion...');
          setTimeout(poll, 3000);
        }
      }

      poll();
    }
  </script>
</body>
</html>
